#!/bin/bash

USERNAME=$(find /home/* -maxdepth 0 -printf "%f" -type d)
export DEBIAN_FRONTEND=noninteractive

check_x_running() {
  if ! xset q &>/dev/null; then
    echo "Please run in X."
    exit
  fi
}

setup_virtualbox() {
  check_is_sudo
  echo "deb http://httpredir.debian.org/debian/ buster main contrib" >> /etc/apt/sources.list
  apt-get update
  apt-get install -y \
          build-essential \
          linux-headers-$(uname -r) \
          virtualbox-guest-x11
}

install_polybar() {
  sudo apt-get install -y \
               cmake \
               cmake-data \
               libcairo2-dev \
               libxcb1-dev \
               libxcb-ewmh-dev \
               libxcb-icccm4-dev \
               libxcb-image0-dev \
               libxcb-randr0-dev \
               libxcb-util0-dev \
               libxcb-xkb-dev \
               pkg-config \
               python-xcbgen \
               xcb-proto \
               libxcb-xrm-dev \
               i3-wm \
               libasound2-dev \
               libpulse-dev \
               libmpdclient-dev \
               libiw-dev \
               libcurl4-openssl-dev \
               libxcb-cursor-dev
  mkdir -p ~/src
  cd ~/src/
  git clone --recursive https://github.com/jaagr/polybar
  mkdir polybar/build
  cd polybar/build/
  cmake ..
  sudo make install
}

# install base system packages
install_base_packages() {
  echo "deb http://ftp.hr.debian.org/debian sid main contrib non-free" >> /etc/apt/sources.list
  apt-get update
  apt-get -y dist-upgrade
  
  apt-get install -y \
          adduser \
          alsa-utils \
          arandr \
          curl \
          dmenu \
          feh \
          git \
          i3 \
          i3lock \
          keepassxc \
          khard \
          lxappearance \
          mpd \
          mutt \
          ncmpcpp \
          offlineimap \
          openvpn \
          pulseaudio \
          pulseaudio-utils \
          rxvt-unicode-256color \
          sudo \
          tmux \
          transmission \
          vdirsyncer \
          vim-nox \
          vlc \
          wicd \
          wicd-curses \
          xautolock \
          xbacklight \
          xclip \
          xorg \
          --no-install-recommends

  # unstable packages
  apt-get install -y -t sid \
          firefox
}

# setup sudo for a user
setup_sudo() {
  adduser $USERNAME sudo
}

# setup system services
setup_system_services() {
  mkdir -p /etc/systemd/system

  cp "/home/$USERNAME/dotfiles/etc/systemd/system/i3lock.service" /etc/systemd/system
  systemctl enable i3lock.service
  systemctl start i3lock.service

  # disable system-wide mpd
  systemctl stop mpd.socket
  systemctl stop mpd
  systemctl disable mpd
  
  # copy mpd service
  mkdir -p /etc/systemd/user
  cp "/home/$USERNAME/dotfiles/etc/systemd/user/mpd.service" /etc/systemd/user
}

# setup user services
setup_user_services() {
  systemctl --user enable mpd.service
  systemctl --user start mpd.service

  echo "*/3 * * * * /home/tb/.bin/oimap-quick.sh" >> /tmp/mycron
  echo "0 * * * * /home/tb/.bin/oimap-full.sh" >> /tmp/mycron
  echo "0 * * * * /home/tb/.vdirsyncer-env/bin/vdirsyncer sync" >> /tmp/mycron
  crontab /tmp/mycron
}

setup() {
  check_is_sudo
  install_base_packages
  setup_sudo
}

configure_system() {
  check_is_sudo
  check_x_running
  setup_system_services
}

configure_user() {
  check_is_not_sudo
  check_x_running
  setup_user_services
  install_polybar
}
