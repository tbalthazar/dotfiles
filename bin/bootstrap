#!/usr/bin/env bash

set -euo pipefail # Exit on error, unset var usage, or failed pipeline

if [ "$EUID" -eq 0 ]; then
  echo "Don't run this script as root."
  exit 1
fi

# --- Get playbook name from argument ---
playbook_base="$1"
if [ -z "$playbook_base" ]; then
  echo "Usage: $0 <playbook-name-without-extension>"
  exit 1
fi
playbook="playbooks/${playbook_base}.yml"

# --- Allow to specify custom repo URL
repo_url=${2:-"https://code.h.tb.io/tb/dotfiles"}

# --- Settings ---
branch="main"
timestamp=$(date +"%Y-%m-%d-%H-%M-%S")
logfile="/tmp/bootstrap-laptop-$timestamp.log"

run_with_messages() {
  local message=$1
  shift || {
    echo "[-] ERROR: run_with_messages requires a command to execute."
    exit 1
  }

  echo -e "[-] ${message} ..."
  if "$@" >>"$logfile" 2>&1; then
    echo -e "[+] done.\n"
  else
    echo -e "[!] Failed, see $logfile for details."
    exit 1
  fi
}

# Step 1: Are we already in sudo group?
echo -e "[-] Checking $(whoami) is in the sudo group ..."
if groups | grep -qw sudo; then
  echo -e "[+] User is in sudo group, done.\n"
else
  echo "[-] Not in sudo group, attempting to add ..."
  su -c "/usr/sbin/usermod -aG sudo $(whoami)"
  echo "[-] User added to sudo group ..."
  echo "[-] Restarting shell with new groups ..."
  exec newgrp sudo <<EONG
$(realpath "$0") $playbook_base $repo_url
EONG
  echo -e "[+] Added in sudo group, done.\n"
fi

echo -e "--- Starting setup at $timestamp ---\n\n" >"$logfile"
echo -e "[-] Starting setup ...\n"

run_with_messages "Asking for sudo password" \
  sudo -v

run_with_messages "Updating packages" \
  bash -lc "sudo apt update && sudo apt dist-upgrade -y && sudo apt autoremove -y"

run_with_messages "Installing required packages" \
  sudo apt install -y ansible git

repo_dest="/tmp/dotfiles"
run_with_messages "Cloning repo" \
  bash -lc "rm -rf \"$repo_dest\" && git clone \"$repo_url\" \"$repo_dest\" && cd \"$repo_dest\" && git checkout \"$branch\""

# --- Check playbook exists ---
if [ ! -f "$repo_dest/ansible/$playbook" ]; then
  echo "[-] ERROR: Playbook '$playbook' not found in repo."
  exit 1
fi

run_with_messages "Run Ansible playbook $playbook_base" \
  bash -lc "cd \"$repo_dest/ansible\" && ANSIBLE_ROLES_PATH=./roles ansible-playbook \"$playbook\" --ask-become-pass"

echo -e "[+] Setup done.\n"
