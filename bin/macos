#!/bin/bash

setup() {
  install_brew
  install_brew_packages
  install_ruby
}

install_brew() {
  if command -v brew; then
    echo "Homebrew installed; updating:"
    brew update
  else
    /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
  fi
}

install_brew_packages() {
  PKGS=('git' 'htop' 'node' 'tmux' 'vim' 'wget' 'yubikey-personalization')

  for pkg in ${PKGS[@]}; do
    if brew list -1 | grep -q "^${pkg}\$"; then
      echo "Package '$pkg' is installed; updating:"
      brew upgrade "$pkg" || true
    else
      brew install "$pkg"
    fi
  done

  brew tap heroku/brew && brew install heroku
}

install_ruby() {
  # rbenv
  RBENV_DIR="$HOME/.rbenv"
  RBENV_REPO="https://github.com/rbenv/rbenv.git"
  if [ -d $RBENV_DIR ]; then
    echo "Updating rbenv..."
    cd $RBENV_DIR
    git pull
  else
    git clone $RBENV_REPO $RBENV_DIR
  fi

  # ruby-build
  RUBY_BUILD_DIR="$RBENV_DIR/plugins/ruby-build"
  RUBY_BUILD_REPO="https://github.com/rbenv/ruby-build.git"
  if [ -d $RUBY_BUILD_DIR ]; then
    echo "Updating ruby-build..."
    cd $RUBY_BUILD_DIR
    git pull
  else
    git clone  $RUBY_BUILD_REPO $RUBY_BUILD_DIR
  fi

  ## Set up ruby
  RUBY_VERSION="2.6.2"
  if [ -d "$RBENV_DIR/versions/$RUBY_VERSION" ]; then
    echo "Ruby $RUBY_VERSION already installed"
  else
    rbenv install "$RUBY_VERSION"
  fi
  eval "$(rbenv init -)"
  rbenv global "$RUBY_VERSION"
  gem install bundler
}

docker() {
  echo "Visit https://docker.com and use the installer provided there"
}
